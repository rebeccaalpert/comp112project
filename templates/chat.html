{% extends "layout.html" %}

{% block content %}
  <div class="container">
    <div class="row">
      <div class="col-md-12">
        <div class="col-md-3">
          <div class="panel panel-info">
            <div class="panel-heading">
              <strong><span class="glyphicon glyphicon-list"></span> Logged in as: <span id="user-name">{{ session['email'] }}</strong>
            </div>
          </div>
          <div class="panel panel-info">
            <div class="panel-heading">
              <strong>Active Users</strong>
            </div>
            <ul id="active-users">
              {% for user in users %}
                {% if user.topic_name == session['room'] %}
                  {% if user.email != session['email'] %}
                    <li class="user"><a href="/private_chat/{{ user.email }}">{{ user.email }}</a></li>
                  {% else %}
                    <li class="user">{{ user.email }}</li>
                  {% endif %}
                {% endif %}
              {% endfor %}
            </ul>
          </div>
          <div class="panel panel-info">
            <div class="panel-heading">
              <strong>Available Chatrooms</strong>
            </div>
            <ul id="chat-rooms">
              {% for topic in topics %}
                {% if topic.topicname %}
                  <li class="topic"><a href="/chat/{{ topic.topicname }}">{{ topic.topicname }}</a></li>
                {% endif %}
              {% endfor %}
            </ul>
          </div>
          <div class="panel panel-info">
            <div class="panel-heading">
              <strong>Add a Chatroom</strong>
            </div>
            <div class="container-fluid">
              {% for message in form.topicname.errors %}
              <div class="alert alert-danger margin-top">{{ message }}</div>
              {% endfor %}
      
              <form id="submit-topic" action="{{ url_for('chat') }}" method="post">
                {{ form.hidden_tag() }}
                
                {{ form.topicname.label }}
                {{ form.topicname }}
                
                {{ form.submit }}
              </form>
            </div>
          </div>
        </div>
        <div class="col-md-9">
          <div class="panel panel-info">
            <div class="panel-heading">
              <strong><span class="glyphicon glyphicon-list"></span> Current Chatroom: <span id="chatroom-name">{{ session['room'] }}</strong>
            </div>
            <div class="panel-body fixed-panel">
              <ul class="media-list" id="chat">
                {% for message in messages %}
                {% if message.topic_name == session['room'] %}
                  <li class="message"><span id="actual_msg">{{ message.text }}</span> 
                    <button type="button" id="translate_btn" class="btn btn-default" aria-label="Left Align"> <span class="glyphicon glyphicon-transfer" aria-hidden="true"></span>
                    </button>
                    <span id="translated"></span>
                    <br />posted by {{ message.user_email }} at {{ message.posted }}</li>
                {% endif %}
              {% endfor %}
              </ul>
            </div>
            <div class="panel-footer">
              <div class="input-group">
                <input type="text" class="form-control" placeholder="Enter Message" id="messageText" autofocus/>
                <span class="input-group-btn">
                  <button class="btn btn-info" type="button" id="sendMessage">SEND <span class="glyphicon glyphicon-send"></span></button>
                </span>
              </div>
            </div>
        </div>
      </div>
      </div>
    </div>
  </div>
</div>
<script>
  $(document).ready(function() {
    key = 'trnsl.1.1.20180323T002815Z.931efcfa06f08dc6.585e129a89a9ad92ac700de57bf10c55bd482438';
    $('#submit').addClass('btn').addClass('btn-info').css('margin-top', '1em');
    $('#topicname').addClass('form-control');
    var channel = "/chat";
    var socket = io.connect('http://' + document.domain + ':' + location.port + channel);
    var receivedMsg;

    var room = $("#chatroom-name").text()

    $(window).bind('beforeunload',function(){
      socket.emit('left', {});
    });
    $("#chat").animate({ scrollTop: $("#chat").prop("scrollHeight") - $('#chat').height() }, 100);

    socket.on('connect', function () {
      socket.emit('joined', { data: { room: room } });
    });

    socket.on('status', function(data) {
      $('#chat').append('<li class="message">' + data.msg + '</li>');
      if (data.msg.includes("has entered") && $('.user:contains("' + data.user + '")').length == 0) {
        $('#active-users').append('<li class="user">' + data.user + '</li>');
      } else if (data.msg.includes("has left")) {
        $('.user:contains("' + data.user + '")').remove();
      }
      $("#chat").animate({ scrollTop: $("#chat").prop("scrollHeight") - $('#chat').height() }, 100);
    });
    
    socket.on('message', function(data) {
      receivedMsg = data;
      console.log(receivedMsg);
      $('#chat').append('<li class="message">' + data.text + '<br />' + 'posted by ' + data.author + data.time + '</li>');
      $("#chat").animate({ scrollTop: $("#chat").prop("scrollHeight") - $('#chat').height() }, 100);
    });

    socket.on('update_topics', function(data) {
      $('#chat-rooms').append('<li class="topic"><a href="/chat/' + titleCase(data.msg.room) + '">' + titleCase(data.msg.room) + '</a></li>');
    });
    
    $('#messageText').keypress(function(e) {
      var code = e.keyCode || e.which;
      if (code == 13) {
        text = $('#messageText').val();
        sendMessage();
        $('#messageText').val('');
      }
    });

    $("#sendMessage").on("click", function () {
        sendMessage();
    });

    $('#submit').on("click", function() {
      if ($('.alert')) {

      } else {
        var name = $("#topicname").val();
        console.log(name);
        socket.emit('new_topic', { data: { room: name } });
        clearMessages();
        socket.emit('left', {});
      }
    });

    $('#chat-rooms').on( 'click', 'a', function () {
      var chatroom = $(this)[0].innerText;
      clearMessages();
      socket.emit('left', {});
      socket.emit('joined', { data: { room: chatroom } });
    });

    $('#translate_btn').on('click', function() {
        if($("#translated").text() != "") {
          $("#translated").html("");
        } else {
          user_email = $('#user-name').text();
          $.when(
            getUserLang(user_email),
            detectLang($("#actual_msg").text()),
          ).then(function(to, from) {
            direction = concatString(from[0].lang, to[0]);
            
            translate($("#actual_msg").text(), direction);

          });
        }
    });

    function clearMessages() {
      $('.media-list li').detach();
    }

    function sendMessage() {
      $container = $('.media-list');
      $container[0].scrollTop = $container[0].scrollHeight;
      var text = $("#messageText").val();
      socket.emit('message', { data: { message: text } });
      $("#messageText").val("");
    }

    function titleCase(str) {
      str = str.toLowerCase().split(' ');
      for (var i = 0; i < str.length; i++) {
        str[i] = str[i].charAt(0).toUpperCase() + str[i].slice(1); 
      }
      return str.join(' ');
    }

    function getUserLang(email) {
      return $.get('http://' + document.domain + ':' + location.port + '/user_language/' + email);
    }

    function detectLang(text) {
      return $.get('https://translate.yandex.net/api/v1.5/tr.json/detect', { key: key, text: text });
    }

    function translate(text, direction) {
       console.log(text + " " + direction);
      $.get('https://translate.yandex.net/api/v1.5/tr.json/translate', { key: key, text: text, lang: direction }, function(data) {
          $("#translated").html(data.text[0]);
        });
    }

    function concatString(from, to) {
      return from + '-' + to;
    }

  });
  </script>

{% endblock %}